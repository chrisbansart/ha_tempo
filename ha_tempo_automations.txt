# Exemples d'automatisations Tempo
# Ã€ copier dans votre configuration.yaml ou automations.yaml

automation:
  # ========================================
  # ðŸ”´ JOUR ROUGE - Ã‰conomies d'Ã©nergie
  # ========================================
  
  # Se dÃ©clenche automatiquement Ã  6h si jour rouge
  - id: tempo_jour_rouge_hp_debut
    alias: "Tempo - DÃ©but jour rouge HP"
    description: "Ã‰conomies d'Ã©nergie en heures pleines rouges"
    trigger:
      - platform: state
        entity_id: sensor.edf_tempo
        attribute: today_red_hp
        to: true
    action:
      # Notification
      - service: notify.mobile_app
        data:
          title: "âš ï¸ Jour Rouge Tempo"
          message: "DÃ©but des heures pleines rouges. Ã‰conomies activÃ©es."
          data:
            priority: high
      
      # RÃ©duire le chauffage
      - service: climate.set_temperature
        target:
          entity_id:
            - climate.salon
            - climate.chambre
        data:
          temperature: 18
      
      # Ã‰teindre le cumulus
      - service: switch.turn_off
        target:
          entity_id: switch.cumulus
      
      # ArrÃªter la charge voiture
      - service: switch.turn_off
        target:
          entity_id: switch.charge_voiture
      
      # Log
      - service: logbook.log
        data:
          name: Tempo
          message: "Passage en jour rouge HP - Ã‰conomies activÃ©es"

  # ========================================
  # ðŸŒ™ HEURES CREUSES - Relancer la conso
  # ========================================
  
  # Se dÃ©clenche automatiquement Ã  22h tous les soirs
  - id: tempo_passage_hc
    alias: "Tempo - Passage en heures creuses"
    description: "Relance des appareils en heures creuses"
    trigger:
      - platform: state
        entity_id: sensor.edf_tempo
        attribute: is_hc
        to: true
    action:
      # Notification
      - service: notify.mobile_app
        data:
          title: "ðŸŒ™ Heures Creuses"
          message: "Passage en heures creuses. Relance des appareils."
      
      # Rallumer le cumulus
      - service: switch.turn_on
        target:
          entity_id: switch.cumulus
      
      # Relancer la charge voiture
      - service: switch.turn_on
        target:
          entity_id: switch.charge_voiture
      
      # RÃ©tablir le chauffage normal
      - service: climate.set_temperature
        target:
          entity_id:
            - climate.salon
            - climate.chambre
        data:
          temperature: 20
      
      # Log
      - service: logbook.log
        data:
          name: Tempo
          message: "Passage en heures creuses - Appareils relancÃ©s"

  # ========================================
  # ðŸŒ… HEURES PLEINES - Stopper appareils
  # ========================================
  
  # Se dÃ©clenche automatiquement Ã  6h tous les matins
  - id: tempo_passage_hp
    alias: "Tempo - Passage en heures pleines"
    description: "ArrÃªt des gros consommateurs en HP"
    trigger:
      - platform: state
        entity_id: sensor.edf_tempo
        attribute: is_hp
        to: true
    condition:
      # Seulement si jour rouge ou blanc
      - condition: template
        value_template: >
          {{ state_attr('sensor.edf_tempo', 'today_color_code') >= 2 }}
    action:
      # Ã‰teindre le cumulus si jour rouge ou blanc
      - service: switch.turn_off
        target:
          entity_id: switch.cumulus
      
      # ArrÃªter la charge voiture
      - service: switch.turn_off
        target:
          entity_id: switch.charge_voiture

  # ========================================
  # ðŸ“… DEMAIN ROUGE - Anticipation
  # ========================================
  
  # Se dÃ©clenche dÃ¨s que la couleur J+1 est connue (vers 7h)
  - id: tempo_demain_rouge
    alias: "Tempo - Alerte demain rouge"
    description: "Notification et actions prÃ©ventives si demain est rouge"
    trigger:
      - platform: state
        entity_id: sensor.edf_tempo
        attribute: tomorrow_is_red
        to: true
    action:
      # Notification importante
      - service: notify.mobile_app
        data:
          title: "ðŸ”´ Alerte Tempo"
          message: "Demain sera un jour ROUGE. PrÃ©parez-vous !"
          data:
            priority: high
            notification_icon: mdi:alert-circle
      
      # Notification persistante dans l'interface
      - service: persistent_notification.create
        data:
          title: "Demain : Jour Rouge Tempo"
          message: |
            âš ï¸ **Demain sera un jour rouge**
            
            Actions recommandÃ©es :
            - Charger la voiture cette nuit
            - Lancer les machines en heures creuses
            - PrÃ©parer les repas ce soir
          notification_id: tempo_tomorrow_red
      
      # Charge complÃ¨te de la voiture cette nuit
      - service: switch.turn_on
        target:
          entity_id: switch.charge_voiture_forcee
      
      # Log
      - service: logbook.log
        data:
          name: Tempo
          message: "Demain sera un jour rouge - Actions prÃ©ventives activÃ©es"

  # ========================================
  # ðŸ’™ DEMAIN BLEU - Information
  # ========================================
  
  - id: tempo_demain_bleu
    alias: "Tempo - Info demain bleu"
    description: "Notification si demain est bleu (tarif avantageux)"
    trigger:
      - platform: state
        entity_id: sensor.edf_tempo
        attribute: tomorrow_is_blue
        to: true
    action:
      - service: notify.mobile_app
        data:
          title: "ðŸ’™ Demain : Jour Bleu"
          message: "Tarif avantageux demain. Profitez-en !"

  # ========================================
  # ðŸŽ¯ CAS COMPLEXE - Jour rouge HC
  # ========================================
  
  # Actions spÃ©cifiques en heures creuses d'un jour rouge
  - id: tempo_rouge_hc
    alias: "Tempo - Jour rouge HC"
    description: "Actions spÃ©cifiques en HC d'un jour rouge"
    trigger:
      - platform: state
        entity_id: sensor.edf_tempo
        attribute: today_red_hc
        to: true
    action:
      # Notification
      - service: notify.mobile_app
        data:
          title: "ðŸ”´ðŸŒ™ Rouge HC"
          message: "Heures creuses d'un jour rouge. Rechargez vos appareils !"
      
      # Charge maximale de tout
      - service: switch.turn_on
        target:
          entity_id:
            - switch.cumulus
            - switch.charge_voiture
            - switch.lave_linge
            - switch.lave_vaisselle

  # ========================================
  # ðŸ“Š STATISTIQUES - Log quotidien
  # ========================================
  
  # Log la couleur du jour chaque matin
  - id: tempo_log_quotidien
    alias: "Tempo - Log quotidien"
    description: "Enregistre la couleur du jour"
    trigger:
      - platform: time
        at: "06:01:00"
    action:
      - service: logbook.log
        data:
          name: "Tempo Quotidien"
          message: >
            Jour {{ state_attr('sensor.edf_tempo', 'today_color') }} 
            (code {{ state_attr('sensor.edf_tempo', 'today_color_code') }})

  # ========================================
  # ðŸ”” RAPPEL SOIRÃ‰E - Si demain rouge
  # ========================================
  
  # Rappel Ã  20h si demain est rouge
  - id: tempo_rappel_soiree
    alias: "Tempo - Rappel soirÃ©e jour rouge"
    description: "Rappel Ã  20h si demain est rouge"
    trigger:
      - platform: time
        at: "20:00:00"
    condition:
      - condition: template
        value_template: "{{ state_attr('sensor.edf_tempo', 'tomorrow_is_red') }}"
    action:
      - service: notify.mobile_app
        data:
          title: "âš ï¸ Rappel Tempo"
          message: |
            Demain sera rouge !
            - Avez-vous lancÃ© la charge voiture ?
            - Les machines sont-elles en route ?

  # ========================================
  # ðŸŽ¨ LUMIÃˆRES - Indicateur visuel
  # ========================================
  
  # Change la couleur d'une LED selon la couleur du jour
  - id: tempo_led_indicator
    alias: "Tempo - Indicateur LED"
    description: "LED indicatrice de la couleur Tempo"
    trigger:
      - platform: state
        entity_id: sensor.edf_tempo
    action:
      - service: light.turn_on
        target:
          entity_id: light.led_tempo
        data:
          rgb_color: >
            {% set color = state_attr('sensor.edf_tempo', 'today_color_en') %}
            {% if color == 'red' %}[255, 0, 0]
            {% elif color == 'white' %}[255, 255, 255]
            {% elif color == 'blue' %}[0, 0, 255]
            {% else %}[128, 128, 128]{% endif %}
          brightness: >
            {{ 255 if state_attr('sensor.edf_tempo', 'is_hp') else 64 }}
